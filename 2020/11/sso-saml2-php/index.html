<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SAML2 on PHP | Learn with Daniel - A learner diary</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon-128.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="A learner diary">
    
    <link rel="preload" href="/assets/css/0.styles.e0c1612b.css" as="style"><link rel="preload" href="/assets/js/app.5632ea00.js" as="script"><link rel="preload" href="/assets/js/3.9e1cc85f.js" as="script"><link rel="preload" href="/assets/js/58.40c5610c.js" as="script"><link rel="preload" href="/assets/js/22.2ffb8c95.js" as="script"><link rel="prefetch" href="/assets/js/10.ab7cb67b.js"><link rel="prefetch" href="/assets/js/11.5242956c.js"><link rel="prefetch" href="/assets/js/12.59c1b827.js"><link rel="prefetch" href="/assets/js/13.eb4c0cc0.js"><link rel="prefetch" href="/assets/js/14.cd6385da.js"><link rel="prefetch" href="/assets/js/15.f6ed5cf0.js"><link rel="prefetch" href="/assets/js/16.60e48bf7.js"><link rel="prefetch" href="/assets/js/17.6ade2139.js"><link rel="prefetch" href="/assets/js/18.f3523bb9.js"><link rel="prefetch" href="/assets/js/19.0cd9be83.js"><link rel="prefetch" href="/assets/js/20.74e5d0bb.js"><link rel="prefetch" href="/assets/js/21.057bc373.js"><link rel="prefetch" href="/assets/js/23.45611473.js"><link rel="prefetch" href="/assets/js/24.2c5aaad4.js"><link rel="prefetch" href="/assets/js/25.53994f14.js"><link rel="prefetch" href="/assets/js/26.4b88dd5e.js"><link rel="prefetch" href="/assets/js/27.33da5e65.js"><link rel="prefetch" href="/assets/js/28.e1bc1897.js"><link rel="prefetch" href="/assets/js/29.41a44f48.js"><link rel="prefetch" href="/assets/js/30.b52a01e3.js"><link rel="prefetch" href="/assets/js/31.32e50696.js"><link rel="prefetch" href="/assets/js/32.9870be67.js"><link rel="prefetch" href="/assets/js/33.6be9bedc.js"><link rel="prefetch" href="/assets/js/34.95333d7a.js"><link rel="prefetch" href="/assets/js/35.b90c291b.js"><link rel="prefetch" href="/assets/js/36.853d11aa.js"><link rel="prefetch" href="/assets/js/37.fe79cc5b.js"><link rel="prefetch" href="/assets/js/38.aef7ef02.js"><link rel="prefetch" href="/assets/js/39.dca7aa67.js"><link rel="prefetch" href="/assets/js/4.37520176.js"><link rel="prefetch" href="/assets/js/40.d659d938.js"><link rel="prefetch" href="/assets/js/41.83aeacc5.js"><link rel="prefetch" href="/assets/js/42.610c5aca.js"><link rel="prefetch" href="/assets/js/43.e9222b3a.js"><link rel="prefetch" href="/assets/js/44.9858f816.js"><link rel="prefetch" href="/assets/js/45.b0f0f5f2.js"><link rel="prefetch" href="/assets/js/46.492b33ea.js"><link rel="prefetch" href="/assets/js/47.07c3328b.js"><link rel="prefetch" href="/assets/js/48.b2d7476f.js"><link rel="prefetch" href="/assets/js/49.9fd583ed.js"><link rel="prefetch" href="/assets/js/5.b259d54e.js"><link rel="prefetch" href="/assets/js/50.9e6ef79d.js"><link rel="prefetch" href="/assets/js/51.8c3776f7.js"><link rel="prefetch" href="/assets/js/52.92a4b980.js"><link rel="prefetch" href="/assets/js/53.3e72d3bc.js"><link rel="prefetch" href="/assets/js/54.e1e107ff.js"><link rel="prefetch" href="/assets/js/55.418768d6.js"><link rel="prefetch" href="/assets/js/56.95ca3ac0.js"><link rel="prefetch" href="/assets/js/57.ea7fb933.js"><link rel="prefetch" href="/assets/js/59.5af9d54f.js"><link rel="prefetch" href="/assets/js/6.70c0bce3.js"><link rel="prefetch" href="/assets/js/60.0c66c22f.js"><link rel="prefetch" href="/assets/js/61.05b88817.js"><link rel="prefetch" href="/assets/js/62.483e5481.js"><link rel="prefetch" href="/assets/js/63.6ab28e82.js"><link rel="prefetch" href="/assets/js/7.8d26dacd.js"><link rel="prefetch" href="/assets/js/8.6beb7cbb.js"><link rel="prefetch" href="/assets/js/9.5015eb07.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.92df942c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e0c1612b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="dark:bg-gray-1000 bg-white dark:text-sepia text-gray-900" data-v-335698aa><header class="border-b-4 dark:border-green-700 border-primary" data-v-335698aa><div class="container mx-auto flex h-20 px-6 items-center"><a href="/" class="dark:text-green-700 text-primary text-3xl router-link-active">
            Learn With Daniel
        </a></div></header> <div class="container mx-auto px-6 md:px-16 py-8 max-w-screen-md" data-v-335698aa><div class="py-8 md:py-16" data-v-335698aa><div data-v-335698aa><span class="dark:bg-gray-800 bg-gray-100 px-3 py-1 mx-1 rounded-full uppercase text-xs font-medium dark:text-green-700 tracking-wider" data-v-335698aa>
                    PHP
                </span><span class="dark:bg-gray-800 bg-gray-100 px-3 py-1 mx-1 rounded-full uppercase text-xs font-medium dark:text-green-700 tracking-wider" data-v-335698aa>
                    SAML2
                </span><span class="dark:bg-gray-800 bg-gray-100 px-3 py-1 mx-1 rounded-full uppercase text-xs font-medium dark:text-green-700 tracking-wider" data-v-335698aa>
                    SSO
                </span></div> <h1 class="dark:text-green-500 text-4xl md:text-6xl py-6" data-v-335698aa>SAML2 on PHP</h1> <p class="author text-sm" data-v-335698aa>
                by <span class="text-base font-bold" data-v-335698aa>Daniel Loureiro</span>
                on <time class="mr-3" data-v-335698aa>Nov 29, 2020</time> <span class="reading-time text-xs uppercase py-4 block md:inline-block md:py-9" data-v-335698aa><vp-icon size="1.5em" name="clock-best" class="inline-block" data-v-335698aa></vp-icon>
                    2 min read
                </span></p></div> <div class="post-wrap text-xl leading-10 pb-8" data-v-335698aa><div class="content__default" data-v-335698aa><p>Let's implement a SAML2 SSO on PHP using the <code>simplesamlphp/saml2</code> library.
</p> <h2 id="basic-concepts"><a href="#basic-concepts" class="header-anchor">#</a> Basic concepts</h2> <div class="iframe"><iframe src="https://docs.google.com/presentation/d/1Hn19iARt_dWFV3ESquXpJqImOK2BRVYYcr31ZzPZEWQ/embed?start=false&amp;loop=false&amp;delayms=3000" allowfullscreen="allowfullscreen" width="960" height="569"></iframe></div> <h2 id="install-saml2-library"><a href="#install-saml2-library" class="header-anchor">#</a> Install <code>saml2</code> library</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">composer</span> require simplesamlphp/saml2:^3
<span class="token function">composer</span> require simplesamlphp/simplesamlphp
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p><code>simplesamlphp</code> is a full authentication server. It's just like <em>Kerberos</em> and <em>FreeRADIUS</em> are for <em>LDAP</em>.</p> <p><code>simplesamlphp</code> is an application, not a library, but we <strong>are not running it</strong>, just using some of its source-code files.</p></div> <h2 id="generate-keys"><a href="#generate-keys" class="header-anchor">#</a> Generate keys</h2> <p>We need public (<code>cert</code>) and private (<code>key</code>) keys.</p> <p><strong>Follow these instructions:</strong> <a href="https://www.akadia.com/services/ssh_test_certificate.html" target="_blank" rel="noopener noreferrer">https://www.akadia.com/services/ssh_test_certificate.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Save them as <code>my.crt</code> (public key) and <code>my.key</code> (private key).</p> <h2 id="metadata-script-for-idp"><a href="#metadata-script-for-idp" class="header-anchor">#</a> Metadata script (for IdP)</h2> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/** Composer. */</span>
<span class="token keyword">require</span> <span class="token string single-quoted-string">'vendor/autoload.php'</span><span class="token punctuation">;</span>

<span class="token comment">/** My domain and cert. */</span>
<span class="token variable">$url</span>       <span class="token operator">=</span> <span class="token string single-quoted-string">'https://learnwithdaniel.com'</span><span class="token punctuation">;</span>
<span class="token variable">$cert_path</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'./my.crt'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">x509_content</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$header</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/-----BEGIN CERTIFICATE-----(.*)-----END CERTIFICATE-----/sm'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token variable">$match</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$match</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** EntityDescriptor. */</span>
<span class="token variable">$entity_descriptor</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">SAML2<span class="token punctuation">\</span>XML<span class="token punctuation">\</span>md<span class="token punctuation">\</span>EntityDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$entity_descriptor</span><span class="token operator">-&gt;</span><span class="token function">setEntityID</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'urn:learnwithdaniel.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$entity_descriptor</span><span class="token operator">-&gt;</span><span class="token function">setID</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// temporary random id</span>

<span class="token comment">/** Contact Person. */</span>
<span class="token variable">$contact_person</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">SAML2<span class="token punctuation">\</span>XML<span class="token punctuation">\</span>md<span class="token punctuation">\</span>ContactPerson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$contact_person</span><span class="token operator">-&gt;</span><span class="token function">setContactType</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'support'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$contact_person</span><span class="token operator">-&gt;</span><span class="token function">setCompany</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'LWD'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$contact_person</span><span class="token operator">-&gt;</span><span class="token function">addEmailAddress</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'loureiro.rg@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$entity_descriptor</span><span class="token operator">-&gt;</span><span class="token function">addContactPerson</span><span class="token punctuation">(</span><span class="token variable">$contact_person</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** Dump root. */</span>
<span class="token variable">$root_element</span> <span class="token operator">=</span> <span class="token variable">$entity_descriptor</span><span class="token operator">-&gt;</span><span class="token function">toXML</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** IDPSSODescriptor. */</span>
<span class="token variable">$idp_sso_descriptor</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">SAML2<span class="token punctuation">\</span>XML<span class="token punctuation">\</span>md<span class="token punctuation">\</span>IDPSSODescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$idp_sso_descriptor</span><span class="token operator">-&gt;</span><span class="token function">setWantAuthnRequestsSigned</span><span class="token punctuation">(</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$idp_sso_descriptor</span><span class="token operator">-&gt;</span><span class="token function">addProtocolSupportEnumeration</span><span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified static-context">SAML2<span class="token punctuation">\</span>Constants</span><span class="token operator">::</span><span class="token constant">NS_SAMLP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$idp_sso_descriptor</span><span class="token operator">-&gt;</span><span class="token function">setNameIDFormat</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token class-name class-name-fully-qualified static-context">SAML2<span class="token punctuation">\</span>Constants</span><span class="token operator">::</span><span class="token constant">NAMEID_EMAIL_ADDRESS</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$sso_service</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">SAML2<span class="token punctuation">\</span>XML<span class="token punctuation">\</span>md<span class="token punctuation">\</span>EndpointType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sso_service</span><span class="token operator">-&gt;</span><span class="token function">setBinding</span><span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified static-context">SAML2<span class="token punctuation">\</span>Constants</span><span class="token operator">::</span><span class="token constant">BINDING_HTTP_POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sso_service</span><span class="token operator">-&gt;</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token variable">$url</span> <span class="token operator">.</span> <span class="token string double-quoted-string">&quot;/sso&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$idp_sso_descriptor</span><span class="token operator">-&gt;</span><span class="token function">addSingleSignOnService</span><span class="token punctuation">(</span><span class="token variable">$sso_service</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$slo_service</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">SAML2<span class="token punctuation">\</span>XML<span class="token punctuation">\</span>md<span class="token punctuation">\</span>EndpointType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$slo_service</span><span class="token operator">-&gt;</span><span class="token function">setBinding</span><span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified static-context">SAML2<span class="token punctuation">\</span>Constants</span><span class="token operator">::</span><span class="token constant">BINDING_HTTP_POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$slo_service</span><span class="token operator">-&gt;</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token variable">$url</span> <span class="token operator">.</span> <span class="token string double-quoted-string">&quot;/slo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$idp_sso_descriptor</span><span class="token operator">-&gt;</span><span class="token function">addSingleLogOutService</span><span class="token punctuation">(</span><span class="token variable">$slo_service</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** Load IdP certificate. */</span>
<span class="token variable">$idp_cert</span>    <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$cert_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$idp_pub_key</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>RobRichards<span class="token punctuation">\</span>XMLSecLibs<span class="token punctuation">\</span>XMLSecurityKey</span><span class="token punctuation">(</span>
    <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>RobRichards<span class="token punctuation">\</span>XMLSecLibs<span class="token punctuation">\</span>XMLSecurityKey</span><span class="token operator">::</span><span class="token constant">RSA_SHA256</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span> <span class="token string single-quoted-string">'type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'public'</span> <span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$idp_pub_key</span><span class="token operator">-&gt;</span><span class="token function">loadKey</span><span class="token punctuation">(</span><span class="token variable">$idp_cert</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** Key Descriptor. */</span>
<span class="token variable">$key_descriptor</span> <span class="token operator">=</span> <span class="token class-name class-name-fully-qualified static-context">SAML2<span class="token punctuation">\</span>Utils</span><span class="token operator">::</span><span class="token function">createKeyDescriptor</span><span class="token punctuation">(</span>
    <span class="token function">x509_content</span><span class="token punctuation">(</span>
        <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$cert_path</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$key_descriptor</span><span class="token operator">-&gt;</span><span class="token function">setUse</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'signing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$idp_sso_descriptor</span><span class="token operator">-&gt;</span><span class="token function">addKeyDescriptor</span><span class="token punctuation">(</span><span class="token variable">$key_descriptor</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">/** Dump IDPSSODescriptor. */</span>
<span class="token variable">$idp_sso_descriptor</span><span class="token operator">-&gt;</span><span class="token function">toXML</span><span class="token punctuation">(</span><span class="token variable">$root_element</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** Print XML. */</span>
<span class="token keyword">echo</span> <span class="token variable">$root_element</span><span class="token operator">-&gt;</span><span class="token property">parentNode</span><span class="token operator">-&gt;</span><span class="token function">saveXML</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Check the slides to understand the code.</p></div> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Change the <em>EntityID</em> (<code>urn:learnwithdaniel</code>), the contact data, and the <em>SSO</em>/<em>SLO</em> endpoints to your own data;</p></div> <h2 id="metadata-script-for-sp"><a href="#metadata-script-for-sp" class="header-anchor">#</a> Metadata script (for SP)</h2> <p>Same script as for <em>IdP</em>.</p> <p>Just use <code>SPSSODescriptor</code> instead of <code>IDPSSODescriptor</code>.</p> <h2 id="idp-and-sp-scripts"><a href="#idp-and-sp-scripts" class="header-anchor">#</a> IdP and SP Scripts</h2> <p>That’s all for now, folks!</p> <p>If this article gets enough access, I will show how to implement the IdP side, as well as the SP side.</p></div></div> <hr class="my-12" data-v-335698aa> <div data-v-335698aa><h2 class="text-xl md:text-3xl pb-10 text-center" data-v-335698aa>Comments</h2> <!----></div></div> <footer class="py-4 bg-gray-800" data-v-335698aa><p class="text-center text-gray-600 text-xs">Copyright 2022 - Daniel Loureiro</p></footer></div><div class="global-ui"><!----><!----><!----></div></div>
    <script src="/assets/js/app.5632ea00.js" defer></script><script src="/assets/js/3.9e1cc85f.js" defer></script><script src="/assets/js/58.40c5610c.js" defer></script><script src="/assets/js/22.2ffb8c95.js" defer></script>
  </body>
</html>
