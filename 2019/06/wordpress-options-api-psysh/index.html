<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Options API in depth with PsySH | Learn with Daniel - A learner diary</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon-128.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="A learner diary">
    
    <link rel="preload" href="/assets/css/0.styles.e0c1612b.css" as="style"><link rel="preload" href="/assets/js/app.5632ea00.js" as="script"><link rel="preload" href="/assets/js/3.9e1cc85f.js" as="script"><link rel="preload" href="/assets/js/24.2c5aaad4.js" as="script"><link rel="preload" href="/assets/js/22.2ffb8c95.js" as="script"><link rel="prefetch" href="/assets/js/10.ab7cb67b.js"><link rel="prefetch" href="/assets/js/11.5242956c.js"><link rel="prefetch" href="/assets/js/12.59c1b827.js"><link rel="prefetch" href="/assets/js/13.eb4c0cc0.js"><link rel="prefetch" href="/assets/js/14.cd6385da.js"><link rel="prefetch" href="/assets/js/15.f6ed5cf0.js"><link rel="prefetch" href="/assets/js/16.60e48bf7.js"><link rel="prefetch" href="/assets/js/17.6ade2139.js"><link rel="prefetch" href="/assets/js/18.f3523bb9.js"><link rel="prefetch" href="/assets/js/19.0cd9be83.js"><link rel="prefetch" href="/assets/js/20.74e5d0bb.js"><link rel="prefetch" href="/assets/js/21.057bc373.js"><link rel="prefetch" href="/assets/js/23.45611473.js"><link rel="prefetch" href="/assets/js/25.53994f14.js"><link rel="prefetch" href="/assets/js/26.4b88dd5e.js"><link rel="prefetch" href="/assets/js/27.33da5e65.js"><link rel="prefetch" href="/assets/js/28.e1bc1897.js"><link rel="prefetch" href="/assets/js/29.41a44f48.js"><link rel="prefetch" href="/assets/js/30.b52a01e3.js"><link rel="prefetch" href="/assets/js/31.32e50696.js"><link rel="prefetch" href="/assets/js/32.9870be67.js"><link rel="prefetch" href="/assets/js/33.6be9bedc.js"><link rel="prefetch" href="/assets/js/34.95333d7a.js"><link rel="prefetch" href="/assets/js/35.b90c291b.js"><link rel="prefetch" href="/assets/js/36.853d11aa.js"><link rel="prefetch" href="/assets/js/37.fe79cc5b.js"><link rel="prefetch" href="/assets/js/38.aef7ef02.js"><link rel="prefetch" href="/assets/js/39.dca7aa67.js"><link rel="prefetch" href="/assets/js/4.37520176.js"><link rel="prefetch" href="/assets/js/40.d659d938.js"><link rel="prefetch" href="/assets/js/41.83aeacc5.js"><link rel="prefetch" href="/assets/js/42.610c5aca.js"><link rel="prefetch" href="/assets/js/43.e9222b3a.js"><link rel="prefetch" href="/assets/js/44.9858f816.js"><link rel="prefetch" href="/assets/js/45.b0f0f5f2.js"><link rel="prefetch" href="/assets/js/46.492b33ea.js"><link rel="prefetch" href="/assets/js/47.07c3328b.js"><link rel="prefetch" href="/assets/js/48.b2d7476f.js"><link rel="prefetch" href="/assets/js/49.9fd583ed.js"><link rel="prefetch" href="/assets/js/5.b259d54e.js"><link rel="prefetch" href="/assets/js/50.9e6ef79d.js"><link rel="prefetch" href="/assets/js/51.8c3776f7.js"><link rel="prefetch" href="/assets/js/52.92a4b980.js"><link rel="prefetch" href="/assets/js/53.3e72d3bc.js"><link rel="prefetch" href="/assets/js/54.e1e107ff.js"><link rel="prefetch" href="/assets/js/55.418768d6.js"><link rel="prefetch" href="/assets/js/56.95ca3ac0.js"><link rel="prefetch" href="/assets/js/57.ea7fb933.js"><link rel="prefetch" href="/assets/js/58.40c5610c.js"><link rel="prefetch" href="/assets/js/59.5af9d54f.js"><link rel="prefetch" href="/assets/js/6.70c0bce3.js"><link rel="prefetch" href="/assets/js/60.0c66c22f.js"><link rel="prefetch" href="/assets/js/61.05b88817.js"><link rel="prefetch" href="/assets/js/62.483e5481.js"><link rel="prefetch" href="/assets/js/63.6ab28e82.js"><link rel="prefetch" href="/assets/js/7.8d26dacd.js"><link rel="prefetch" href="/assets/js/8.6beb7cbb.js"><link rel="prefetch" href="/assets/js/9.5015eb07.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.92df942c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e0c1612b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="dark:bg-gray-1000 bg-white dark:text-sepia text-gray-900" data-v-335698aa><header class="border-b-4 dark:border-green-700 border-primary" data-v-335698aa><div class="container mx-auto flex h-20 px-6 items-center"><a href="/" class="dark:text-green-700 text-primary text-3xl router-link-active">
            Learn With Daniel
        </a></div></header> <div class="container mx-auto px-6 md:px-16 py-8 max-w-screen-md" data-v-335698aa><div class="py-8 md:py-16" data-v-335698aa><div data-v-335698aa><span class="dark:bg-gray-800 bg-gray-100 px-3 py-1 mx-1 rounded-full uppercase text-xs font-medium dark:text-green-700 tracking-wider" data-v-335698aa>
                    WordPress
                </span><span class="dark:bg-gray-800 bg-gray-100 px-3 py-1 mx-1 rounded-full uppercase text-xs font-medium dark:text-green-700 tracking-wider" data-v-335698aa>
                    PHP
                </span><span class="dark:bg-gray-800 bg-gray-100 px-3 py-1 mx-1 rounded-full uppercase text-xs font-medium dark:text-green-700 tracking-wider" data-v-335698aa>
                    WP Plugin Development
                </span><span class="dark:bg-gray-800 bg-gray-100 px-3 py-1 mx-1 rounded-full uppercase text-xs font-medium dark:text-green-700 tracking-wider" data-v-335698aa>
                    PsySH
                </span></div> <h1 class="dark:text-green-500 text-4xl md:text-6xl py-6" data-v-335698aa>Options API in depth with PsySH</h1> <p class="author text-sm" data-v-335698aa>
                by <span class="text-base font-bold" data-v-335698aa>Daniel Loureiro</span>
                on <time class="mr-3" data-v-335698aa>Jun 17, 2019</time> <span class="reading-time text-xs uppercase py-4 block md:inline-block md:py-9" data-v-335698aa><vp-icon size="1.5em" name="clock-best" class="inline-block" data-v-335698aa></vp-icon>
                    12 min read
                </span></p></div> <div class="post-wrap text-xl leading-10 pb-8" data-v-335698aa><div class="content__default" data-v-335698aa><p>In this article, let's discover the Options API in depth. Let's learn how to use PsySH to check what WordPress does behind the scenes and much more.
</p> <h2 id="the-options-api"><a href="#the-options-api" class="header-anchor">#</a> The <code>Options API</code></h2> <p>Storing data is a hard task: you have to write SQL, be performant, be concerned with SQL-injection, have to escape your data, serialize it - and unescape, unserialize when getting the data back. It's a lot of work and concerns.</p> <p>The Options API provides a simple way to save and load data without having to deal with all these headaches. There's no need for serialization, escaping, SQL, etc. You just store and load your variables as they are.</p> <p>Main functions:</p> <ul><li><strong>Get:</strong> <code>get_option( $key )</code>;</li> <li><strong>Set:</strong> <code>update_option( $key, $value )</code>;</li></ul> <p>The <code>update_option</code> function stores a value in the database. If <code>$key</code> exists, it updates the value. If it doesn't exist, it creates a new key/value.</p> <p>Two other functions complete the Options API, but they are rarely used:</p> <ul><li><strong>Delete:</strong> <code>delete_option( $key )</code>;</li> <li><strong>Set</strong>: <code>add_option( $key, $value )</code>;</li></ul> <p>The <code>add_option</code> works like <code>update_option</code>, but only works if the key doesn't exist. If the key exists, it doesn't do anything - it doesn't update, nor errors.</p> <h2 id="playing-with-the-interactive-shell"><a href="#playing-with-the-interactive-shell" class="header-anchor">#</a> Playing with the interactive shell</h2> <p>PHP has an interactive shell (aka &quot;REPL&quot;) embedded. It's a sandbox to play with code, extremely useful when developing. Type <code>php -a</code> in your command line to start it.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>php -a
Interactive mode enabled

php <span class="token operator">&gt;</span> <span class="token variable">$color</span> <span class="token operator">=</span> <span class="token string">'blue'</span><span class="token punctuation">;</span>
php <span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;My favorite color is <span class="token variable">$color</span>!&quot;</span><span class="token punctuation">;</span>
My favorite color is blue<span class="token operator">!</span>
</code></pre></div><h3 id="psysh"><a href="#psysh" class="header-anchor">#</a> PsySH</h3> <p>If you like the interactive shell, I <strong>strongly recommend</strong> you <a href="https://psysh.org/" target="_blank" rel="noopener noreferrer">PsySH<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. It's prettier and more powerful than the standard PHP shell.</p> <p>PsySH is well maintained as it is a core part of the popular Laravel framework.</p> <p><img src="/assets/img/psysh.3706ced2.png" alt="PsySH screenshot"></p> <p>Some of its Good Stuff:</p> <ul><li>No need for semicolons <code>;</code></li> <li>Has a pretty color scheme;</li> <li>No need for echos/var_dumps;</li> <li>Better display of complex types (associative arrays, objects, etc);</li></ul> <h3 id="wordpress-on-interactive-mode"><a href="#wordpress-on-interactive-mode" class="header-anchor">#</a> WordPress on Interactive mode</h3> <p>To play with WordPress on the interactive shell, load the <code>wp-load.php</code> file.</p> <p>Go to the root folder of your WordPress installation and type:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># I prefer PsySH, but you can use `php -a` for these examples.</span>
psysh
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">require</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'wp-load.php'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token number">1</span>
</code></pre></div><p>Now, you can play with the WordPress APIs:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'hello'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">false</span>
</code></pre></div><h4 id="help-i-got-an-error-loading-wp-load-php"><a href="#help-i-got-an-error-loading-wp-load-php" class="header-anchor">#</a> Help: I got an error loading <code>wp-load.php</code>!</h4> <p>You need to start the interactive shell in the root of your WordPress installation. If you get the following error, it means you started the shell in the wrong folder:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>PHP Warning:  require<span class="token punctuation">(</span>wp-load.php<span class="token punctuation">)</span>: failed to <span class="token function">open</span> stream: No such <span class="token function">file</span> or directory <span class="token keyword">in</span> php shell code on line <span class="token number">1</span>
PHP Fatal error:  require<span class="token punctuation">(</span><span class="token punctuation">)</span>: Failed opening required <span class="token string">'wp-load.php'</span> <span class="token punctuation">(</span>include_path<span class="token operator">=</span><span class="token string">'.:/usr/share/php'</span><span class="token punctuation">)</span> <span class="token keyword">in</span> php shell code on line <span class="token number">1</span>
</code></pre></div><h3 id="playing-with-the-options-api-on-psysh"><a href="#playing-with-the-options-api-on-psysh" class="header-anchor">#</a> Playing with the Options API on PsySH</h3> <p>Let's try the Options API functions:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>psysh
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// Load WordPress.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">require</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'wp-load.php'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token number">1</span>

<span class="token comment">// Load an inexisting key.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_key'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">false</span>

<span class="token comment">// Create.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_key'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'hello world!'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">true</span>

<span class="token comment">// Load saved value.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_key'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;hello world!&quot;</span>
</code></pre></div><p>If a key doesn't exist, <code>get_option</code> returns <code>false</code>. Pass a second optional argument to change this.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_inexisting_option'</span><span class="token punctuation">,</span> <span class="token constant">null</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token constant">null</span>
</code></pre></div><p>Use this to either detect when the key doesn't exist or to set a default value for the option.</p> <p><code>update_option</code> returns <code>true</code> if the key doesn't exist and <code>false</code> if it exists.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// True means the key didn't exist (create).</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'some_key'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Hello!'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">true</span>

<span class="token comment">// False means the key exists (update).</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'some_key'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'World?'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">false</span>
</code></pre></div><p>Questions:</p> <ul><li>What happens when you try to store an associative array, like <code>['age' =&gt; 30]</code>, without serializing it?</li> <li>What about storing a normal array, like <code>['hello', 'world']</code>?</li> <li>Could the infamous Bobby Tables cause issues if we don't escape our values?</li></ul> <p>To answer these questions better, let's see under the hood how Options API is accessing the database.</p> <h3 id="displaying-sql-queries-on-psysh"><a href="#displaying-sql-queries-on-psysh" class="header-anchor">#</a> Displaying SQL queries on PsySH</h3> <p>To see the queries being executed on the shell, run this command after loading <code>wp-load.php</code>:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'query'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token variable">$sql</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">dump</span><span class="token punctuation">(</span> <span class="token variable">$sql</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token variable">$sql</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre></div><p>Full example:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">require</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'wp-load.php'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token number">1</span>

<span class="token comment">// Enable SQL showing.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'query'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token variable">$sql</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">dump</span><span class="token punctuation">(</span> <span class="token variable">$sql</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token variable">$sql</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">true</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'hello'</span> <span class="token punctuation">)</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;SELECT option_value FROM wp_options WHERE option_name = 'hello' LIMIT 1&quot;</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">false</span>
</code></pre></div><p>Now that we can see WordPress accessing the database, we can have a clear understanding of its inner working.</p> <h4 id="load-wordpress-on-psysh-startup"><a href="#load-wordpress-on-psysh-startup" class="header-anchor">#</a> Load WordPress on PsySH Startup</h4> <p>It's boring and repetitive to type <code>require</code> and <code>add_filter</code> each time we open PsySH. Luckily, PsySH has a feature to help with this. Just create a <code>.psysh.php</code> file, and PsySH will execute it when starting up.</p> <p>Create <code>.psysh.php</code> file at the root of your WordPress project:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/** .psysh.php **/</span>

<span class="token comment">// Load WordPress.</span>
<span class="token keyword">require</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'wp-load.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Display WP queries on the shell.</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'query'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token variable">$sql</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">dump</span><span class="token punctuation">(</span> <span class="token variable">$sql</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token variable">$sql</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre></div><p>Now, when we start PsySH, WordPress is already loaded for us:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>❯ psysh
Psy Shell v0.10.7 <span class="token punctuation">(</span>PHP <span class="token number">7.4</span>.16 — cli<span class="token punctuation">)</span> by Justin Hileman

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> get_option<span class="token punctuation">(</span> <span class="token string">'hello'</span> <span class="token punctuation">)</span>
^ <span class="token string">&quot;SELECT option_value FROM wp_options WHERE option_name = 'hello' LIMIT 1&quot;</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
</code></pre></div><p>Add to <code>.psysh.php</code> any code that you want to be executed when opening a PsySH session.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>The <code>.psysh.php</code> file is not global. It's folder-based. PsySH only executes <code>.psysh.php</code> files that are in the same folder.</p></div> <h2 id="options-api-database"><a href="#options-api-database" class="header-anchor">#</a> Options API Database</h2> <p>The Options API values are stored on the <code>wp_options</code> databse table.</p> <p>Let's check how our <code>my_key</code> is stored on the database:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>mysql -u root my_wordpress_db
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code>MariaDB <span class="token punctuation">[</span>my_wordpress_db<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">SHOW</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+</span>
<span class="token operator">|</span> Tables_in_wordpress_my_book <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+</span>
<span class="token operator">|</span> wp_commentmeta              <span class="token operator">|</span>
<span class="token operator">|</span> wp_comments                 <span class="token operator">|</span>
<span class="token operator">|</span> wp_links                    <span class="token operator">|</span>
<span class="token operator">|</span> wp_options                  <span class="token operator">|</span>
<span class="token operator">|</span> wp_postmeta                 <span class="token operator">|</span>
<span class="token operator">|</span> wp_posts                    <span class="token operator">|</span>
<span class="token operator">|</span> wp_term_relationships       <span class="token operator">|</span>
<span class="token operator">|</span> wp_term_taxonomy            <span class="token operator">|</span>
<span class="token operator">|</span> wp_termmeta                 <span class="token operator">|</span>
<span class="token operator">|</span> wp_terms                    <span class="token operator">|</span>
<span class="token operator">|</span> wp_usermeta                 <span class="token operator">|</span>
<span class="token operator">|</span> wp_users                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+</span>
<span class="token number">12</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.001</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span>my_wordpress_db<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> wp_options <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> option_id <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+----------+----------+</span>
<span class="token operator">|</span> option_id <span class="token operator">|</span> option_name <span class="token operator">|</span> option_value <span class="token operator">|</span> autoload <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-------------+--------------+----------+</span>
<span class="token operator">|</span>       <span class="token number">236</span> <span class="token operator">|</span> my_key      <span class="token operator">|</span> hello world<span class="token operator">!</span> <span class="token operator">|</span> yes      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-------------+--------------+----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.001</span> sec<span class="token punctuation">)</span>
</code></pre></div><h3 id="help-my-tables-don-t-start-with-wp"><a href="#help-my-tables-don-t-start-with-wp" class="header-anchor">#</a> Help: My tables don't start with <code>wp_</code>!</h3> <p>During the installation process, you will be asked to inform a prefix for your tables.
<img src="/assets/img/wp-installation-step1.fbf1d8d4.png" alt="WordPress Installation - Step 1, showing the prefix option"></p> <p>By default, the prefix is <code>wp_</code>, but the name will be different if you set a different prefix. For example, if you define a <code>my_awesome_website</code> as your prefix, the options table will be <code>my_awesome_websiteoptions</code>.</p> <p>You can programatically get the prefix through the <code>$wpdb-&gt;prefix</code> global variable:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>psysh
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">global</span> <span class="token variable">$wpdb</span><span class="token punctuation">;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token variable">$wpdb</span><span class="token operator">-&gt;</span><span class="token property">prefix</span>
<span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;wp_&quot;</span>
</code></pre></div><h2 id="complex-data"><a href="#complex-data" class="header-anchor">#</a> Complex data</h2> <p>The Options API automatically serializes and unserializes complex data like arrays and associative arrays.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token variable">$associative</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'fruit'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'orange'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'age'</span> <span class="token operator">=&gt;</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'company'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'Zoogle'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
     <span class="token string double-quoted-string">&quot;fruit&quot;</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;orange&quot;</span><span class="token punctuation">,</span>
     <span class="token string double-quoted-string">&quot;age&quot;</span> <span class="token operator">=&gt;</span> <span class="token number">55</span><span class="token punctuation">,</span>
     <span class="token string double-quoted-string">&quot;company&quot;</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;Zoogle&quot;</span><span class="token punctuation">,</span>
   <span class="token punctuation">]</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_associative'</span><span class="token punctuation">,</span> <span class="token variable">$associative</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">true</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_associative'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
     <span class="token string double-quoted-string">&quot;fruit&quot;</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;orange&quot;</span><span class="token punctuation">,</span>
     <span class="token string double-quoted-string">&quot;age&quot;</span> <span class="token operator">=&gt;</span> <span class="token number">55</span><span class="token punctuation">,</span>
     <span class="token string double-quoted-string">&quot;company&quot;</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;Zoogle&quot;</span><span class="token punctuation">,</span>
   <span class="token punctuation">]</span>
</code></pre></div><p>We get the same array we saved. No need to serialize/unserialize.</p> <h2 id="sql-injection"><a href="#sql-injection" class="header-anchor">#</a> SQL-Injection</h2> <p>The Options API is immune to SQL-Injection attacks. We don't need to escape a value before storing it.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// The infamous Bobby Tables.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;Robert'); DROP TABLE Students;--&quot;</span><span class="token punctuation">;</span>
<span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;Robert'); DROP TABLE Students;--&quot;</span>

<span class="token comment">// Let's save this value on a SQL database.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'student_name'</span><span class="token punctuation">,</span> <span class="token variable">$name</span> <span class="token punctuation">)</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;SELECT option_value FROM wp_options WHERE option_name = 'student_name' LIMIT 1&quot;</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;INSERT INTO `wp_options` (`option_name`, `option_value`, `autoload`) VALUES ('student_name', 'Robert\'); DROP TABLE Students;--', 'yes') ON DUPLICATE KEY UPDATE `option_name` = VALUES(`option_name`), `option_value` = VALUES(`option_value`), `autoload` = VALUES(`autoload`)&quot;</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">false</span>
</code></pre></div><p><code>update_options()</code> properly escaped the value for us. No need to be concerned about SQL-injection when using the Options API.</p> <p>Now, let's retrieve the value:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'student_name'</span><span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;Robert'); DROP TABLE Students;--&quot;</span>
</code></pre></div><p>Perfect! The result came back untouched. No need to unescape it as well.</p> <h3 id="sql-injection-on-the-key"><a href="#sql-injection-on-the-key" class="header-anchor">#</a> SQL-Injection on the key</h3> <p>The Options API is also immune to malicious data set as the key name:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// The infamous Bobby Tables.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;Robert'); DROP TABLE Students;--&quot;</span><span class="token punctuation">;</span>
<span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;Robert'); DROP TABLE Students;--&quot;</span>

<span class="token comment">// Let's save this as the key name.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token punctuation">)</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;SELECT option_value FROM wp_options WHERE option_name = 'Robert\'); DROP TABLE Students;--' LIMIT 1&quot;</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;INSERT INTO `wp_options` (`option_name`, `option_value`, `autoload`) VALUES ('Robert\'); DROP TABLE Students;--', '10', 'yes') ON DUPLICATE KEY UPDATE `option_name` = VALUES(`option_name`), `option_value` = VALUES(`option_value`), `autoload` = VALUES(`autoload`)&quot;</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">true</span>
</code></pre></div><p>That's awesome. No need to escape anything.</p> <h3 id="xss-attacks"><a href="#xss-attacks" class="header-anchor">#</a> XSS Attacks</h3> <p>The Options API doesn't prevent XSS Attacks and that's a good thing.</p> <p>You must always HTML-escape before outputting results unless you want to print HTML.</p> <p>Use the <code>esc_attr( $str )</code> function to HTML-escape:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$age</span>         <span class="token operator">=</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'age'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$escaped_age</span> <span class="token operator">=</span> <span class="token function">esc_attr</span><span class="token punctuation">(</span> <span class="token variable">$age</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;&lt;input name='age' value='${escaped_age}' /&gt;&quot;</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="html-escaping-before-storing"><a href="#html-escaping-before-storing" class="header-anchor">#</a> HTML-Escaping before storing?</h3> <p>Do not HTML-escape values before storing them. Store the values as they are, untouched, in their purest form, and only escape them before printing.</p> <p>The only escape you do before storing values is for SQL-injection or anything related to the storage.</p> <p>Reasons to not store HTML-escaped values:</p> <ul><li>If there's a bug in the escaping function, how would you fix the problem? Update the entire database?</li> <li><code>echo esc_attr( $str )</code> is a lot safer than <code>echo $str</code>;</li> <li><code>I &lt;3 you</code> and <code>I &amp;lt;3 you</code> are not the same data. When you need to use the data outside the HTML context, you will have issues;</li></ul> <h2 id="autoloaded-options-and-cache"><a href="#autoloaded-options-and-cache" class="header-anchor">#</a> Autoloaded Options and Cache</h2> <p>You may have noticed an <code>autoload</code> attribute on the database. What does it mean?</p> <p>The Options API uses cache to speed up things. Let's see it in action:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'some-option'</span> <span class="token punctuation">)</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;SELECT option_value FROM wp_options WHERE option_name = 'some-option' LIMIT 1&quot;</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">false</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'some-option'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">false</span>
</code></pre></div><p>There's no database activity on the second time we read <code>some-option</code>. That's the cache system in action. The Options API already knows the value of the option. There's no need to look at the database again.</p> <p>Even if you update a value, Options API is smart enought to not need to load it from the database:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'some-option'</span><span class="token punctuation">,</span> <span class="token number">20</span> <span class="token punctuation">)</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;INSERT INTO `wp_options` (`option_name`, `option_value`, `autoload`) VALUES ('some-option', '20', 'yes')&quot;</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">true</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'some-option'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token number">20</span>
</code></pre></div><p>You don't need to do anything about the cache. It just works out of the box.</p> <p>Now that we understand how the cache works let's investigate the <code>autoload</code> option.</p> <h3 id="the-autoload-attribute"><a href="#the-autoload-attribute" class="header-anchor">#</a> The <code>autoload</code> attribute</h3> <p>When we access a page, WordPress reads many individual options. These options are from WordPress core and also from installed plugins.</p> <p>This means lots of individual database queries being triggered on each page load. Each <code>get_option()</code> will generate a query.</p> <p>WordPress has a solution for this problem: when it starts up, it fetches all these options in a batch, in one big query. As a rule of thumb, the fewer queries, the better. Getting all results in one big query is more performant than many small individual queries.</p> <p>The result of this big query is used to load the cache. With this, the first time a <code>get_option()</code> is called, it won't query the database.</p> <p>In practical terms, we replace many small queries with a single big one. We replace many <code>WHERE option_id = 1</code> with a <code>WHERE autoload = 'yes'</code> executed on <code>wp-load.php</code>.</p> <p>We mark the options to be auto-loaded by setting their <code>autoload</code> attribute to <code>yes</code> on the database.</p> <p>On <code>update_option()</code>, we have an optional boolean argument to set the autoload. It's the third argument.</p> <p>Let's check all of this by creating two options - one autoloaded and the other not:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// Tells WordPress to autoload this new option.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_autoload_true'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span> <span class="token punctuation">)</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;SELECT option_value FROM wp_options WHERE option_name = 'my_autoload_true' LIMIT 1&quot;</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;INSERT INTO `wp_options` (`option_name`, `option_value`, `autoload`) VALUES ('my_autoload_true', '10', 'yes') ON DUPLICATE KEY UPDATE `option_name` = VALUES(`option_name`), `option_value` = VALUES(`option_value`), `autoload` = VALUES(`autoload`)&quot;</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">true</span>

<span class="token comment">// Tells WordPress to NOT autoload this one.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_autoload_false'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span> <span class="token punctuation">)</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;SELECT option_value FROM wp_options WHERE option_name = 'my_autoload_false' LIMIT 1&quot;</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;INSERT INTO `wp_options` (`option_name`, `option_value`, `autoload`) VALUES ('my_autoload_false', '10', 'no') ON DUPLICATE KEY UPDATE `option_name` = VALUES(`option_name`), `option_value` = VALUES(`option_value`), `autoload` = VALUES(`autoload`)&quot;</span>
<span class="token operator">=&gt;</span> <span class="token constant boolean">true</span>
</code></pre></div><p>Now close and re-open PsySH:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_autoload_true'</span> <span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;10&quot;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_autoload_false'</span> <span class="token punctuation">)</span>
<span class="token operator">^</span> <span class="token string double-quoted-string">&quot;SELECT option_value FROM wp_options WHERE option_name = 'my_autoload_false' LIMIT 1&quot;</span>
<span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;10&quot;</span>
</code></pre></div><p>As expected, the option set to true was already on the cache, loaded by <code>wp-load.php</code>. The option set to false had to be loaded from the database.</p> <div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>I recommend always setting autoload to <code>false</code> and only set it to <code>true</code> when needed on every page (or most pages). Otherwise, you will hinder the performance by loading unnecessary data.</p></div> <h2 id="filters-and-actions"><a href="#filters-and-actions" class="header-anchor">#</a> Filters and Actions</h2> <p>There are filters and actions in all Options API functions. Read their source code to check what is available.</p> <h2 id="naming-best-practices"><a href="#naming-best-practices" class="header-anchor">#</a> Naming best practices</h2> <p>Let's say your plugin has an option named <code>color</code> that stores your plugin's background color. It all works well until another plugin stores their favorite color in an option also named <code>color</code>.</p> <p>The result will be catastrophic. One plugin will mess with the data of the other.</p> <p>To prevent naming conflicts, it is a good practice to prepend your names with something unique, like your plugin's name:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_plugin_color'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'blue'</span> <span class="token punctuation">)</span>
</code></pre></div><h2 id="final-words"><a href="#final-words" class="header-anchor">#</a> Final words</h2> <p>The Options API is mostly used by plugins' settings pages on the admin side. Still, it is powerful enough to be used in different scenarios.</p> <p>WordPress has other ways to store and retrieve data. Use the ones that fit your needs best.</p></div></div> <hr class="my-12" data-v-335698aa> <div data-v-335698aa><h2 class="text-xl md:text-3xl pb-10 text-center" data-v-335698aa>Comments</h2> <!----></div></div> <footer class="py-4 bg-gray-800" data-v-335698aa><p class="text-center text-gray-600 text-xs">Copyright 2022 - Daniel Loureiro</p></footer></div><div class="global-ui"><!----><!----><!----></div></div>
    <script src="/assets/js/app.5632ea00.js" defer></script><script src="/assets/js/3.9e1cc85f.js" defer></script><script src="/assets/js/24.2c5aaad4.js" defer></script><script src="/assets/js/22.2ffb8c95.js" defer></script>
  </body>
</html>
